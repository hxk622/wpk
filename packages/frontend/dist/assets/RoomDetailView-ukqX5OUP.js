import{m as G,n as me,p as ve,q as he,a as c,v as pe,x as fe,r as b,_ as ye,y as _e,z as H,i as Y,o as ge,s as d,A as ke,c as _,b as o,d as g,B as A,w as v,C as j,D as T,g as be,h,t as f,F as U,f as z,u as E,j as B}from"./index-DuysnCwA.js";import{r as S}from"./room-MDMjkgn2.js";import{u as Se}from"./user-aMWrx1op.js";import"./axios-DCPBCOZw.js";import"./logger-BnKYzyre.js";let $;const we={title:"",width:"",theme:null,message:"",overlay:!0,callback:null,teleport:"body",className:"",allowHtml:!1,lockScroll:!0,transition:void 0,beforeClose:null,overlayClass:"",overlayStyle:void 0,messageAlign:"",cancelButtonText:"",cancelButtonColor:null,cancelButtonDisabled:!1,confirmButtonText:"",confirmButtonColor:null,confirmButtonDisabled:!1,showConfirmButton:!0,showCancelButton:!1,closeOnPopstate:!0,closeOnClickOverlay:!1,destroyOnClose:!1};let Ce=G({},we);function Re(){({instance:$}=ve({setup(){const{state:s,toggle:a}=he();return()=>c(fe,pe(s,{"onUpdate:show":a}),null)}}))}function xe(w){return me?new Promise((s,a)=>{$||Re(),$.open(G({},Ce,w,{callback:n=>{(n==="confirm"?s:a)(n)}}))}):Promise.resolve(void 0)}const Z=w=>xe(G({showCancelButton:!0},w));class Pe{constructor(){this.socket=null,this.url="ws://localhost:3000",this.eventHandlers=new Map,this.isConnecting=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=2e3,this.isConnected=b(!1),this.eventHandlers=new Map}connect(s){return new Promise((a,n)=>{if(this.socket?.readyState===WebSocket.OPEN){a(!0);return}if(this.isConnecting){const i=()=>{this.socket?.readyState===WebSocket.OPEN?a(!0):this.socket?.readyState===WebSocket.CLOSED?n(new Error("WebSocket连接失败")):setTimeout(i,100)};i();return}this.isConnecting=!0;try{this.socket=new WebSocket(`${this.url}?userId=${s}`),this.socket.onopen=()=>{console.log("WebSocket连接已建立"),this.isConnected.value=!0,this.isConnecting=!1,this.reconnectAttempts=0,a(!0)},this.socket.onmessage=i=>{try{const k=JSON.parse(i.data);this.handleMessage(k)}catch(k){console.error("解析WebSocket消息失败:",k)}},this.socket.onclose=i=>{console.log("WebSocket连接已关闭:",i.code,i.reason),this.isConnected.value=!1,this.isConnecting=!1,this.attemptReconnect(s)},this.socket.onerror=i=>{console.error("WebSocket连接错误:",i),this.isConnecting=!1,n(i)}}catch(i){console.error("创建WebSocket连接失败:",i),this.isConnecting=!1,n(i)}})}disconnect(){this.socket?.readyState===WebSocket.OPEN&&this.socket.close(),this.socket=null,this.isConnected.value=!1,this.eventHandlers.clear()}send(s,a){if(!this.socket||this.socket.readyState!==WebSocket.OPEN){console.error("WebSocket未连接，无法发送消息");return}const n={type:s,data:a};try{this.socket.send(JSON.stringify(n))}catch(i){console.error("发送WebSocket消息失败:",i)}}on(s,a){this.eventHandlers.has(s)||this.eventHandlers.set(s,[]),this.eventHandlers.get(s)?.push(a)}off(s,a){if(this.eventHandlers.has(s)){const n=this.eventHandlers.get(s)?.filter(i=>i!==a)||[];n.length>0?this.eventHandlers.set(s,n):this.eventHandlers.delete(s)}}offAll(){this.eventHandlers.clear()}handleMessage(s){console.log("收到WebSocket消息:",s);const{type:a,data:n}=s;this.eventHandlers.has(a)&&this.eventHandlers.get(a)?.forEach(i=>{try{i(n)}catch(k){console.error(`处理WebSocket事件 ${a} 失败:`,k)}})}attemptReconnect(s){this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectAttempts++,console.log(`尝试重新连接 (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`),setTimeout(()=>{this.connect(s).catch(a=>{console.error("重连失败:",a)})},this.reconnectDelay)):console.error("达到最大重连尝试次数，停止重连")}joinRoom(s){this.send("join_room",{roomId:s})}leaveRoom(s){this.send("leave_room",{roomId:s})}sendPlayerReadyStatus(s,a){this.send("player_ready_status",{roomId:s,isReady:a})}sendGameAction(s,a,n){this.send("game_action",{sessionId:s,action:a,data:n})}sendChatMessage(s,a){this.send("chat_message",{roomId:s,content:a})}}const y=new Pe,Ie={class:"room-detail"},Ae={class:"room-detail-container"},Be={class:"room-info"},We={class:"info-item"},Ne={class:"value"},Oe={class:"info-item"},Ve={class:"value"},De={class:"info-item"},Me={class:"value"},He={class:"info-item"},je={class:"value"},Te={class:"info-item"},Ue={class:"value status-{{ roomInfo.status }}"},ze={class:"players-list"},Ee={class:"player-avatar"},$e={key:0,class:"ready-indicator"},Ge={class:"player-info"},Le={class:"player-name"},Fe={class:"player-stack"},Je={key:0,class:"player-actions"},qe={class:"player-avatar empty"},Ke={class:"action-buttons"},Qe={key:1,class:"in-room-actions"},Xe={key:0,class:"chat-container"},Ye={class:"chat-messages"},Ze={class:"message-avatar"},et={class:"message-content"},tt={class:"message-name"},st={class:"message-text"},ot={class:"chat-input"},nt={class:"settings-content"},at={__name:"RoomDetailView",setup(w){const s=be(),n=_e().params.id,i=Se(),k=H(()=>i.userInfo),p=k?.id,l=Y({id:n,smallBlind:10,bigBlind:20,gameMode:"no_limit",maxPlayers:6,currentPlayers:0,status:"waiting",gameStarted:!1,players:[],ownerId:null}),W=b(!1),N=b(!1),x=b(!1),u=b(!1),O=b([]),P=b(""),L=b(0),C=Y({sound:!0,bgMusic:!0,aiAssist:!0}),F=H(()=>l.ownerId===p),ee=H(()=>l.players.filter(e=>e.ready).length>=2),te=t=>({no_limit:"无限注",limit:"有限注",pot_limit:"固定注"})[t]||t,se=t=>({waiting:"等待中",playing:"游戏中",finished:"已结束"})[t]||t,V=async()=>{try{const t=await S.getRoomDetail(n),e=t.room||t;if(e){Object.assign(l,e);const m=l.players.find(R=>R.id===p);x.value=!!m,m&&(u.value=m.ready)}}catch(t){console.error("加载房间信息失败:",t),d(t.message||"加载房间信息失败")}},oe=async()=>{try{W.value=!0,await S.joinRoom(n),d("加入房间成功"),await V(),p&&y.joinRoom(Number(n))}catch(t){console.error("加入房间失败:",t),d(t.message||"加入房间失败")}finally{W.value=!1}},J=()=>{Z({title:"确认离开",message:"确定要离开房间吗？"}).then(async()=>{try{y.leaveRoom(Number(n)),await S.leaveRoom(n),d("离开房间成功"),s.push("/rooms")}catch(t){console.error("离开房间失败:",t),d(t.message||"离开房间失败")}}).catch(()=>{})},ne=()=>{x.value?J():s.push("/rooms")},ae=async()=>{try{y.sendPlayerReadyStatus(Number(n),!u.value),u.value=!u.value;const t=l.players.findIndex(m=>m.id===p);t!==-1&&(l.players[t].ready=u.value),d(u.value?"已准备":"已取消准备");const e=await S.toggleReady(n,!u.value);e&&e.error&&(u.value=!u.value,t!==-1&&(l.players[t].ready=u.value),d(e.error||"操作失败"))}catch(t){console.error("切换准备状态失败:",t),u.value=!u.value;const e=l.players.findIndex(m=>m.id===p);e!==-1&&(l.players[e].ready=u.value),d("操作失败，请检查网络连接")}},re=t=>{Z({title:"确认踢出",message:"确定要将该玩家踢出房间吗？"}).then(async()=>{try{const e=await S.kickPlayer(n,t);e&&!e.error?(d("踢出成功"),await V()):d(e?.error||"踢出失败")}catch(e){console.error("踢出玩家失败:",e),d(e.message||"踢出失败")}}).catch(()=>{})},le=async()=>{try{N.value=!0;const t=await S.startGame(n);t&&!t.error?(d("游戏开始"),s.push(`/game/${n}`)):d(t?.error||"开始游戏失败")}catch(t){console.error("开始游戏失败:",t),d(t.message||"开始游戏失败")}finally{N.value=!1}},ie=async()=>{if(!P.value.trim())return;const t={senderId:p,username:k?.username||"我",avatar:k?.avatar,content:P.value.trim(),timestamp:new Date().toISOString()};O.value.push(t),P.value="";try{y.sendChatMessage(Number(n),t.content),await S.sendMessage(n,t.content)}catch(e){console.error("发送消息失败:",e),O.value.pop(),d(e.message||"发送消息失败")}};return ge(()=>{V(),p&&y.connect(p).then(()=>{y.joinRoom(Number(n)),y.on("room_state_update",t=>{if(t.room||t){const e=t.room||t;Object.assign(l,e);const m=l.players.find(R=>R.id===p);x.value=!!m,m&&(u.value=m.ready)}}),y.on("player_joined",t=>{d(`${t.username||"玩家"} 加入了房间`)}),y.on("player_left",t=>{d(`${t.username||"玩家"} 离开了房间`)}),y.on("player_ready_status",t=>{const e=l.players.find(m=>m.id===t.playerId);e&&(e.ready=t.ready,t.playerId===p&&(u.value=t.ready))})}).catch(t=>{console.error("WebSocket连接失败:",t),d("无法连接到服务器，请稍后重试")})}),ke(()=>{y.leaveRoom(Number(n)),y.offAll()}),(t,e)=>{const m=g("van-nav-bar"),R=g("van-card"),q=g("van-image"),K=g("van-icon"),I=g("van-button"),ce=g("van-field"),Q=g("van-tab"),D=g("van-switch"),M=g("van-cell"),de=g("van-cell-group"),ue=g("van-tabs");return h(),_("div",Ie,[c(m,{title:"房间详情","left-text":"退出","left-arrow":"",onClickLeft:ne}),o("div",Ae,[c(R,{class:"room-info-card",title:"房间信息",bordered:!1},{default:v(()=>[o("div",Be,[o("div",We,[e[5]||(e[5]=o("span",{class:"label"},"房间号：",-1)),o("span",Ne,f(l.id),1)]),o("div",Oe,[e[6]||(e[6]=o("span",{class:"label"},"盲注：",-1)),o("span",Ve,f(l.smallBlind)+" / "+f(l.bigBlind),1)]),o("div",De,[e[7]||(e[7]=o("span",{class:"label"},"游戏模式：",-1)),o("span",Me,f(te(l.gameMode)),1)]),o("div",He,[e[8]||(e[8]=o("span",{class:"label"},"玩家数量：",-1)),o("span",je,f(l.currentPlayers)+" / "+f(l.maxPlayers),1)]),o("div",Te,[e[9]||(e[9]=o("span",{class:"label"},"状态：",-1)),o("span",Ue,f(se(l.status)),1)])])]),_:1}),c(R,{class:"players-card",title:"玩家列表",bordered:!1},{default:v(()=>[o("div",ze,[(h(!0),_(U,null,z(l.players,(r,X)=>(h(),_("div",{key:r.id,class:T(["player-item",{"current-player":r.id===E(p),ready:r.ready}])},[o("div",Ee,[c(q,{src:r.avatar||"https://img.yzcdn.cn/vant/cat.jpeg",round:"",width:"48",height:"48"},null,8,["src"]),r.ready?(h(),_("div",$e,[c(K,{name:"checked",size:"16",color:"#07c160"})])):A("",!0)]),o("div",Ge,[o("div",Le,f(r.username),1),o("div",Fe,"筹码："+f(r.stack||0),1)]),F.value&&r.id!==E(p)?(h(),_("div",Je,[c(I,{size:"small",type:"danger",onClick:rt=>re(r.id)},{default:v(()=>[...e[10]||(e[10]=[B(" 踢出 ",-1)])]),_:1},8,["onClick"])])):A("",!0)],2))),128)),(h(!0),_(U,null,z(l.maxPlayers-l.currentPlayers,r=>(h(),_("div",{key:"empty-"+r,class:"player-item empty"},[o("div",qe,[c(K,{name:"plus",size:"24",color:"#969799"})]),e[11]||(e[11]=o("div",{class:"player-info"},[o("div",{class:"player-name"},"空位")],-1))]))),128))])]),_:1}),o("div",Ke,[x.value?(h(),_("div",Qe,[l.gameStarted?A("",!0):(h(),j(I,{key:0,type:"info",block:"",onClick:ae,class:T({"ready-btn":u.value})},{default:v(()=>[B(f(u.value?"取消准备":"准备"),1)]),_:1},8,["class"])),c(I,{type:"danger",block:"",onClick:J,style:{"margin-top":"10px"}},{default:v(()=>[...e[13]||(e[13]=[B(" 离开房间 ",-1)])]),_:1}),F.value&&!l.gameStarted&&ee.value?(h(),j(I,{key:1,type:"success",block:"",onClick:le,style:{"margin-top":"10px"},loading:N.value},{default:v(()=>[...e[14]||(e[14]=[B(" 开始游戏 ",-1)])]),_:1},8,["loading"])):A("",!0)])):(h(),j(I,{key:0,type:"primary",block:"",onClick:oe,loading:W.value},{default:v(()=>[...e[12]||(e[12]=[B(" 加入房间 ",-1)])]),_:1},8,["loading"]))]),x.value?(h(),_("div",Xe,[c(ue,{active:L.value,"onUpdate:active":e[4]||(e[4]=r=>L.value=r)},{default:v(()=>[c(Q,{title:"聊天"},{default:v(()=>[o("div",Ye,[(h(!0),_(U,null,z(O.value,(r,X)=>(h(),_("div",{key:X,class:T(["chat-message",{"own-message":r.senderId===E(p)}])},[o("div",Ze,[c(q,{src:r.avatar||"https://img.yzcdn.cn/vant/cat.jpeg",round:"",width:"28",height:"28"},null,8,["src"])]),o("div",et,[o("div",tt,f(r.username),1),o("div",st,f(r.content),1)])],2))),128))]),o("div",ot,[c(ce,{modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=r=>P.value=r),placeholder:"输入消息...","left-icon":"chat-o","right-icon":"send",onClickRightIcon:ie},null,8,["modelValue"])])]),_:1}),c(Q,{title:"设置"},{default:v(()=>[o("div",nt,[c(de,{inset:""},{default:v(()=>[c(M,{title:"音效",value:""},{"right-icon":v(()=>[c(D,{modelValue:C.sound,"onUpdate:modelValue":e[1]||(e[1]=r=>C.sound=r),size:"24px"},null,8,["modelValue"])]),_:1}),c(M,{title:"背景音乐",value:""},{"right-icon":v(()=>[c(D,{modelValue:C.bgMusic,"onUpdate:modelValue":e[2]||(e[2]=r=>C.bgMusic=r),size:"24px"},null,8,["modelValue"])]),_:1}),c(M,{title:"AI辅助",value:""},{"right-icon":v(()=>[c(D,{modelValue:C.aiAssist,"onUpdate:modelValue":e[3]||(e[3]=r=>C.aiAssist=r),size:"24px"},null,8,["modelValue"])]),_:1})]),_:1})])]),_:1})]),_:1},8,["active"])])):A("",!0)])])}}},mt=ye(at,[["__scopeId","data-v-0700c15c"]]);export{mt as default};
